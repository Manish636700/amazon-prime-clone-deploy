---
# ===============================
# INSTALL POSTGRESQL
# ===============================
- name: Install PostgreSQL
  yum:
    name:
      - postgresql15
      - postgresql15-server
    state: present
    update_cache: yes

# ===============================
# INIT DB (RUNS ONLY ONCE)
# ===============================
- name: Initialize PostgreSQL (one-time)
  command: postgresql-setup --initdb
  args:
    creates: /var/lib/pgsql/data/PG_VERSION

# ===============================
# START SERVICE
# ===============================
- name: Start PostgreSQL
  systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Wait for PostgreSQL
  shell: pg_isready
  register: pg_ready
  retries: 10
  delay: 3
  until: pg_ready.rc == 0
  changed_when: false

# ===============================
# AUTH CONFIG (IDEMPOTENT)
# ===============================

# Remove any conflicting postgres rules
- name: Remove conflicting postgres auth rules
  lineinfile:
    path: /var/lib/pgsql/data/pg_hba.conf
    regexp: '^local\s+all\s+postgres\s+'
    state: absent
  notify: restart postgresql

# Ensure peer auth for postgres user (TOP of file)
- name: Ensure peer auth for postgres user
  lineinfile:
    path: /var/lib/pgsql/data/pg_hba.conf
    insertafter: BOF
    line: 'local   all   postgres   peer'
  notify: restart postgresql

# Enforce md5 for all other local users
- name: Enforce md5 auth for local users
  lineinfile:
    path: /var/lib/pgsql/data/pg_hba.conf
    regexp: '^local\s+all\s+all\s+'
    line: 'local   all   all   md5'
  notify: restart postgresql

- meta: flush_handlers

# ===============================
# VERIFY AUTH (FAIL FAST)
# ===============================
- name: Verify postgres peer authentication
  shell: sudo -u postgres psql -c "SELECT 1;"
  register: pg_auth_check
  failed_when: pg_auth_check.rc != 0
  changed_when: false

# ===============================
# DB USER (IDEMPOTENT)
# ===============================
- name: Ensure sonar DB user exists
  shell: |
    sudo -u postgres psql <<EOF
    DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='sonar') THEN
        CREATE USER sonar WITH PASSWORD 'Sonar@123';
      END IF;
    END
    \$\$;
    EOF
  changed_when: false

# ===============================
# DATABASE (IDEMPOTENT)
# ===============================
- name: Ensure SonarQube database exists
  shell: |
    sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='sonarqube'" | grep -q 1 \
    || sudo -u postgres psql -c "CREATE DATABASE sonarqube OWNER sonar;"
  changed_when: false

# ===============================
# PERMISSIONS (SAFE)
# ===============================
- name: Ensure schema permissions
  shell: |
    sudo -u postgres psql sonarqube <<EOF
    ALTER SCHEMA public OWNER TO sonar;
    GRANT ALL ON SCHEMA public TO sonar;
    EOF
  changed_when: false
