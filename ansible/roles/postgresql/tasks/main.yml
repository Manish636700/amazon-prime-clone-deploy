---
# ===============================
# INSTALL POSTGRESQL 15
# ===============================
- name: Install PostgreSQL packages
  yum:
    name:
      - postgresql15
      - postgresql15-server
    state: present
    update_cache: yes

# ===============================
# INITIALIZE DATABASE (RUN ONCE)
# ===============================
- name: Initialize PostgreSQL database
  command: postgresql-setup --initdb
  args:
    creates: /var/lib/pgsql/data/PG_VERSION

# ===============================
# START & ENABLE SERVICE
# ===============================
- name: Start and enable PostgreSQL
  systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Wait for PostgreSQL to be ready
  shell: pg_isready
  register: pg_ready
  retries: 10
  delay: 3
  until: pg_ready.rc == 0
  changed_when: false

# ===============================
# AUTH CONFIG (BULLETPROOF)
# ===============================
# IMPORTANT:
# PostgreSQL reads pg_hba.conf top â†’ bottom
# We fully control this file to avoid IDENT issues
- name: Enforce PostgreSQL authentication for SonarQube
  copy:
    dest: /var/lib/pgsql/data/pg_hba.conf
    owner: postgres
    group: postgres
    mode: '0600'
    content: |
      # TYPE  DATABASE        USER            ADDRESS                 METHOD

      local   all             postgres                                peer
      local   all             all                                     md5
      host    all             all             127.0.0.1/32            md5
      host    all             all             ::1/128                 md5
  notify: restart postgresql

- meta: flush_handlers

# ===============================
# FAIL-FAST AUTH VERIFICATION
# ===============================
- name: Verify postgres peer authentication
  shell: sudo -u postgres psql -c "SELECT 1;"
  register: pg_auth_check
  failed_when: pg_auth_check.rc != 0
  changed_when: false

# ===============================
# DB USER (IDEMPOTENT)
# ===============================
- name: Ensure sonar DB user exists
  shell: |
    sudo -u postgres psql <<EOF
    DO \$\$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='sonar') THEN
        CREATE USER sonar WITH PASSWORD 'Sonar@123';
      END IF;
    END
    \$\$;
    EOF
  changed_when: false

# ===============================
# DATABASE (IDEMPOTENT)
# ===============================
- name: Ensure SonarQube database exists
  shell: |
    sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='sonarqube'" | grep -q 1 \
    || sudo -u postgres psql -c "CREATE DATABASE sonarqube OWNER sonar;"
  changed_when: false

# ===============================
# PERMISSIONS
# ===============================
- name: Ensure schema permissions for sonar user
  shell: |
    sudo -u postgres psql sonarqube <<EOF
    ALTER SCHEMA public OWNER TO sonar;
    GRANT ALL ON SCHEMA public TO sonar;
    EOF
  changed_when: false
